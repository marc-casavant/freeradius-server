name        = proxy

raddbdir    = /etc/freeradius
confdir     = ${raddbdir}
modconfdir  = ${confdir}/mods-config
logdir      = /var/log/freeradius
radacctdir  = ${logdir}/radacct

templates {
	{% include "environments/configs/freeradius/proxy/template.d/proxy-templates" %}
}

security {
        allow_core_dumps = yes
}

# logging configuration required for linelog module
log {
	destination = files
	file = ${logdir}/radius.log
	syslog_facility = daemon
	stripped_names = no
	auth = yes
	auth_badpass = yes
	auth_goodpass = yes
}

modules {
	# Common linelog module configuration
	{% include "environments/configs/freeradius/common/mods-available/linelog" %}

	# Test-framework specific linelog module configuration based on OS environment
	{% if listener_type == "unix" %}
        {% include "environments/configs/freeradius/common/mods-available/linelog_socket" %}
	{% elif listener_type == "file" %}
        {% include "environments/configs/freeradius/common/mods-available/linelog_file" %}
	{% endif %}

	# radius module instance configuration
	{% for i in range(1, (proxy_num_of_dst_servers + 1)) %}
	radius radius-module-dst-server{{ i }} {
		$template radius-module-dst-server-tmpl
		udp {
			ipaddr = {{ proxy_dst_server_name }}{{ i }}
		}
	}
	{% endfor %}

}

policy {
	# Common control policy configuration
	{% include "environments/configs/freeradius/common/policy.d/control" %}
}

server proxy {

	namespace = radius

	listen authentication {
		type = Access-Request
		type = Status-Server
		transport = udp
		require_message_authenticator = auto
		limit_proxy_state = auto

		limit {
			max_clients = 256
			max_connections = 256
			idle_timeout = 60.0
			dynamic_timeout = 600.0
			nak_lifetime = 30.0
			cleanup_delay = 5.0
		}

		udp {
			ipaddr = *
			port = 1812
			networks {
				allow = 127/8
				allow = 192.0.2/24
			}
		}

		tcp {
			ipaddr = *
			port = 1812
			networks {
				allow = 127/8
				allow = 192.0.2/24
			}
		}
	}

	listen authentication {
		type = Access-Request
		type = Status-Server
		transport = tcp

		tcp {
			ipaddr = *
			port = 1812
			networks {
				allow = 127/8
				allow = 192.0.2/24
			}
		}
	}

        listen accounting {
		type = Accounting-Request
		transport = udp
		udp {
			ipaddr = *
			port = 1813
		}
	}

	client upstream-proxy {
		ipaddr = $ENV{TEST_SUBNET}
		secret = testing123
		require_message_authenticator = auto
		limit_proxy_state = auto
	}

	recv Access-Request {
		# Use the load-generator-proxy authenticate logic
		control.Auth-Type := "redundant-load-balance-proxy"
	}

	authenticate redundant-load-balance-proxy {
		# Use redundant-load-balance to distribute requests to multiple home servers
		redundant-load-balance {
			{% for i in range(1, (proxy_num_of_dst_servers + 1)) %}
			radius-module-dest-server{{ i }}
			{% endfor %}
		}
	}

	send Access-Accept {
		stats
	}

	send Access-Reject {
		stats
	}

}
