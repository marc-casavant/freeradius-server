timeout: 70
state_order: sequence
states:
  state_1:
    description: Baseline load-generator test for load-generator -> 5 home servers. Home servers auto-accept requests.
    host:
      load-generator:
        actions:
        - execute_command:
            command: |
              #
              # proto_load configuration via environment variables
              #
              # export TEST_CONF_START_PPS=1000 && export TEST_CONF_MAX_PPS=10000 && export TEST_CONF_DURATION=5 && export TEST_CONF_STEP=1000 && export TEST_CONF_PARALLEL=100 && export TEST_CONF_MAX_BACKLOG=10000 TEST_CONF_REPEAT="no" && sleep 15 && ./docker-entrypoint.sh

              export TEST_CONF_START_PPS=5
              export TEST_CONF_MAX_PPS=10
              # Duration must be equal or greater than max pps for proto_load to calculate "pps_accepted" effectively
              export TEST_CONF_DURATION=5
              export TEST_CONF_STEP=5
              export TEST_CONF_PARALLEL=1
              export TEST_CONF_MAX_BACKLOG=1000
              export TEST_CONF_REPEAT="no"

              TEST_CONF_NUM_MESSAGES=0
              for ((pps=$TEST_CONF_START_PPS; pps<=$TEST_CONF_MAX_PPS; pps+=$TEST_CONF_STEP)); do
                TEST_CONF_NUM_MESSAGES=$((TEST_CONF_NUM_MESSAGES + TEST_CONF_DURATION * pps))
              done
              export TEST_CONF_NUM_MESSAGES

              #
              # Delay to allow the rest of the environment to startup before starting load generation
              #
              sleep 20

              #
              # Starting load-generator server which will generate traffic based on env configuration
              # from above.
              #
              /docker-entrypoint.sh &
              tail -f /dev/null

            detach: true
    verify:
      timeout: 30
      trigger_mode: unordered
      triggers:
      - hs_access_request_received:
          all:
            pattern:
              reg_pattern: (\d+)-(\d+)-(\d+)-(\d+):(\d+):(\d+) Homeserver (\d+\.\d+\.\d+\.\d+):(\d+) rx Access-Request.*
  state_2:
    description: Check load-generator Status-Server stats
    host:
      load-generator:
        actions:
        - execute_command:
            command: |
              printf 'User-Name := "testuser"\nUser-Password := "testpass"' | /usr/bin/radclient -x localhost:1820 status testing123
    verify:
      timeout: 5
      trigger_mode: unordered
      triggers:
      - loadgen-recv-status-server:
          all:
            pattern:
              reg_pattern: \- INFO \- (\d+) requests processed successfully,
